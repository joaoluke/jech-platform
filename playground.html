<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Playground - Jech</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="playground.css" />
    <script src="js/playground/wasm-loader.js"></script>
  </head>
  <body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">üöÄ JECH</a>
            <div class="nav-links">
                <a href="index.html">In√≠cio</a>
                <a href="playground.html" class="active">Playground</a>
                <a href="docs.html">Documenta√ß√£o</a>
                <a href="https://github.com/joaoluke/jech" target="_blank" rel="noopener noreferrer">
                    <span class="github-icon">GitHub</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="playground-container">
        <div class="playground-header">
            <h1 class="playground-title">Jech Playground</h1>
            <div class="playground-controls">
                <button id="runBtn" class="playground-btn playground-btn-primary" disabled>
                    <span class="run-icon">‚ñ∂</span> Executar (Ctrl+Enter)
                </button>
                <button id="clearBtn" class="playground-btn playground-btn-secondary" disabled>
                    <span class="clear-icon">üóëÔ∏è</span> Limpar
                </button>
            </div>
        </div>

        <div class="playground-main">
            <div class="playground-panel">
                <div class="playground-panel-header">
                    <span>üìù</span> C√≥digo Fonte
                </div>
                <div class="playground-panel-content">
                    <textarea id="editor" spellcheck="false" placeholder="Digite seu c√≥digo Jech aqui..."></textarea>
                </div>
            </div>
            
            <div class="playground-panel">
                <div class="playground-panel-header">
                    <span>üì§</span> Sa√≠da
                </div>
                <div class="playground-panel-content">
                    <pre id="output" class="empty">A sa√≠da do seu c√≥digo aparecer√° aqui...</pre>
                </div>
            </div>
        </div>

        <div class="playground-examples">
            <span class="playground-examples-label">Exemplos:</span>
            <button class="example-btn" onclick="loadExample('hello')">üëã Ol√° Mundo</button>
            <button class="example-btn" onclick="loadExample('variables')">üî¢ Vari√°veis</button>
            <button class="example-btn" onclick="loadExample('conditionals')">üîÄ Condicionais</button>
            <button class="example-btn" onclick="loadExample('loops')">üîÑ Loops</button>
            <button class="example-btn" onclick="loadExample('functions')">üì¶ Fun√ß√µes</button>
        </div>

        <div id="status" class="playground-status">
            <span class="loader"></span> Inicializando o interpretador Jech...
        </div>
    </div>

    <script>
      // C√≥digos de exemplo
      const examples = {
        hello: 'say("üëã Ol√°, Mundo!");\n',
        variables: '// Vari√°veis e tipos b√°sicos\nkeep nome = "Jech";\nkeep versao = 1.0;\nkeep ativo = 1;\n\n// Concatena√ß√£o de strings\nsay("Bem-vindo ao " + nome + " " + versao);\n\n// Opera√ß√µes matem√°ticas\nkeep x = 10;\nkeep y = 5;\nkeep soma = x + y;\n\nsay(x + " + " + y + " = " + soma);',
        conditionals: '// Estruturas condicionais\nkeep idade = 20;\n\nwhen (idade >= 18) {\n  say("Voc√™ √© maior de idade!");\n} else {\n  say("Voc√™ √© menor de idade!");\n}\n\n// Operadores l√≥gicos\nkeep tem_carteira = 1;\n\nwhen (idade >= 18 && tem_carteira) {\n  say("Pode dirigir!");\n} else {\n  say("N√£o pode dirigir!");\n}',
        loops: '// Loops\nkeep i = 0;\n\n// Loop while\nwhile (i < 5) {\n  say("Contagem: " + i);\n  i = i + 1;\n}\n\n// Loop for\nfor (keep j = 0; j < 3; j = j + 1) {\n  say("Itera√ß√£o: " + j);\n}',
        functions: '// Fun√ß√µes\ndo saudacao(nome) {\n  say("Ol√°, " + nome + "!");\n  return "Sauda√ß√£o enviada para " + nome;\n}\n\n// Chamando a fun√ß√£o\nkeep mensagem = saudacao("Visitante");\nsay("Retorno: " + mensagem);'
      };

      // Elementos da interface
      const editor = document.getElementById('editor');
      const output = document.getElementById('output');
      const runBtn = document.getElementById('runBtn');
      const clearBtn = document.getElementById('clearBtn');
      const statusElement = document.querySelector('.playground-status');

      // Estado do interpretador
      let isReady = false;

      // Inicializar o interpretador Jech
      async function initJech() {
        try {
          updateStatus('‚è≥ Inicializando o interpretador Jech...');
          
          // Configurar callback para receber a sa√≠da do WASM
          JechWASM.setOutputCallback((text) => {
            output.textContent = text;
            output.classList.remove('empty');
            output.scrollTop = output.scrollHeight;
          });
          
          // Inicializar o m√≥dulo WASM
          await JechWASM.init();
          
          // Verificar se o m√≥dulo foi inicializado corretamente
          if (!JechWASM.isInitialized()) {
            throw new Error('Falha ao inicializar o interpretador Jech');
          }
          
          // Obter a vers√£o do interpretador
          const version = await JechWASM.getVersion();
          console.log(`Jech ${version} inicializado com sucesso!`);
          
          // Atualizar estado
          isReady = true;
          runBtn.disabled = false;
          clearBtn.disabled = false;
          updateStatus(`‚úÖ Jech v${version} pronto!`, 'ready');
          
          // Carregar exemplo inicial
          loadExample('hello');
          
        } catch (error) {
          console.error('Erro ao inicializar o interpretador Jech:', error);
          updateStatus(`‚ùå Falha ao inicializar: ${error.message}`, 'error');
          appendOutput(`Erro cr√≠tico: ${error.message}`, true);
        }
      }

      // Carregar exemplo
      function loadExample(name) {
        if (examples[name]) {
          editor.value = examples[name];
          
          // Rolar para o topo do editor
          editor.scrollTop = 0;
          
          // Mostrar mensagem de exemplo carregado
          updateStatus(`‚úÖ Exemplo "${name.replace(/([A-Z])/g, ' $1').trim()}" carregado`);
          
          // Focar no editor
          editor.focus();
          
          // Ajustar altura do editor
          updateEditorHeight();
        } else {
          updateStatus('‚ùå Exemplo n√£o encontrado', 'error');
        }
      }

      // Atualizar status
      function updateStatus(message, type = '') {
        statusElement.textContent = message;
        statusElement.className = 'playground-status' + (type ? ` ${type}` : '');
      }

      // Executar c√≥digo
      async function runCode() {
        if (!isReady) {
          updateStatus('‚ùå O interpretador ainda n√£o est√° pronto. Por favor, aguarde...', 'error');
          return;
        }
        
        const code = editor.value.trim();
        if (!code) {
          updateStatus('‚ùå Nenhum c√≥digo para executar', 'error');
          return;
        }
        
        // Limpar sa√≠da anterior
        clearOutput();
        
        // Mostrar o c√≥digo que est√° sendo executado
        const codePreview = document.createElement('div');
        codePreview.className = 'code-preview';
        codePreview.innerHTML = `
          <div class="code-preview-header">üöÄ Executando c√≥digo...</div>
          <div class="code-separator">-------------------</div>
          <pre>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
          <div class="code-separator">-------------------</div>
        `;
        output.appendChild(codePreview);
        
        // Executar o c√≥digo
        const startTime = performance.now();
        updateStatus('‚ö° Executando...', 'running');
        
        try {
          // Executar o c√≥digo usando o JechWASM
          const result = await JechWASM.execute(code);
          const executionTime = ((performance.now() - startTime) / 1000).toFixed(2);
          
          if (result) {
            updateStatus(`‚úÖ Executado com sucesso (${executionTime}s)`, 'success');
          } else {
            updateStatus(`‚ùå Erro durante a execu√ß√£o (${executionTime}s)`, 'error');
          }
        } catch (error) {
          console.error('Erro ao executar c√≥digo:', error);
          const errorMessage = error.message || 'Erro desconhecido';
          appendOutput(`‚ùå Erro: ${errorMessage}`, true);
          updateStatus('‚ùå Erro durante a execu√ß√£o', 'error');
        }
      }

      // Limpar sa√≠da
      function clearOutput() {
        output.textContent = 'A sa√≠da do seu c√≥digo aparecer√° aqui...';
        output.className = 'empty';
        JechWASM.clearOutput();
      }

      // Adicionar texto √† sa√≠da
      function appendOutput(text, isError = false) {
        // Se a sa√≠da estiver vazia, remover a classe 'empty'
        if (output.classList.contains('empty')) {
          output.textContent = '';
          output.className = '';
        }
        
        // Criar elemento de linha de sa√≠da
        const line = document.createElement('div');
        line.className = isError ? 'output-line error' : 'output-line';
        
        // Processar quebras de linha e adicionar cada linha
        const lines = text.split('\n');
        lines.forEach((lineText, index) => {
          if (index > 0) {
            output.appendChild(document.createElement('br'));
          }
          if (lineText) {
            const textNode = document.createTextNode(lineText);
            output.appendChild(textNode);
          }
        });
        
        // Rolar para a √∫ltima linha
        output.scrollTop = output.scrollHeight;
      }

      // Event listeners
      runBtn.addEventListener('click', runCode);
      clearBtn.addEventListener('click', clearOutput);
      
      // Atalhos de teclado
      document.addEventListener('keydown', (e) => {
        // Ctrl+Enter ou Cmd+Enter para executar
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          runCode();
        }
      });
      
      // Configurar altura do editor
      function updateEditorHeight() {
        editor.style.height = 'auto';
        editor.style.height = (editor.scrollHeight) + 'px';
      }
      
      // Inicializar o editor
      function initEditor() {
        // Configurar eventos do editor
        editor.addEventListener('input', updateEditorHeight);
        window.addEventListener('resize', updateEditorHeight);
        updateEditorHeight();
        
        // Inicializar o interpretador Jech
        initJech();
      }
      
      // Inicializar quando o DOM estiver pronto
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEditor);
      } else {
        initEditor();
      }
    </script>
  </body>
</html>
