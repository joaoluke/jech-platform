<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Playground - Jech</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="playground.css" />
    <script src="js/playground/wasm-loader.js"></script>
  </head>
  <body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">ğŸš€ JECH</a>
            <div class="nav-links">
                <a href="index.html">InÃ­cio</a>
                <a href="playground.html" class="active">Playground</a>
                <a href="docs.html">DocumentaÃ§Ã£o</a>
                <a href="https://github.com/joaoluke/jech" target="_blank" rel="noopener noreferrer">
                    <span class="github-icon">GitHub</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="playground-container">
        <div class="playground-header">
            <h1 class="playground-title">Jech Playground</h1>
            <div class="playground-controls">
                <button id="runBtn" class="playground-btn playground-btn-primary">
                    <span class="run-icon">â–¶</span> Executar (Ctrl+Enter)
                </button>
                <button id="clearBtn" class="playground-btn playground-btn-secondary">
                    <span class="clear-icon">ğŸ—‘ï¸</span> Limpar
                </button>
            </div>
        </div>

        <div class="playground-main">
            <div class="playground-panel">
                <div class="playground-panel-header">
                    <span>ğŸ“</span> CÃ³digo Fonte
                </div>
                <div class="playground-panel-content">
                    <textarea id="editor" spellcheck="false" placeholder="Digite seu cÃ³digo Jech aqui..."></textarea>
                </div>
            </div>
            
            <div class="playground-panel">
                <div class="playground-panel-header">
                    <span>ğŸ“¤</span> SaÃ­da
                </div>
                <div class="playground-panel-content">
                    <pre id="output" class="empty">A saÃ­da do seu cÃ³digo aparecerÃ¡ aqui...</pre>
                </div>
            </div>
        </div>

        <div class="playground-examples">
            <span class="playground-examples-label">Exemplos:</span>
            <button class="example-btn" onclick="loadExample('hello')">ğŸ‘‹ OlÃ¡ Mundo</button>
            <button class="example-btn" onclick="loadExample('variables')">ğŸ”¢ VariÃ¡veis</button>
            <button class="example-btn" onclick="loadExample('conditionals')">ğŸ”€ Condicionais</button>
            <button class="example-btn" onclick="loadExample('loops')">ğŸ”„ Loops</button>
            <button class="example-btn" onclick="loadExample('functions')">ğŸ“¦ FunÃ§Ãµes</button>
        </div>

        <div id="status" class="playground-status">
            <span class="loader"></span> Inicializando o interpretador Jech...
        </div>
    </div>

    <script>
      // CÃ³digos de exemplo
      const examples = {
        hello: 'say("ğŸ‘‹ OlÃ¡, Mundo!");\n',
        variables: '// VariÃ¡veis e tipos bÃ¡sicos\nkeep nome = "Jech";\nkeep versao = 1.0;\nkeep ativo = 1;\n\n// ConcatenaÃ§Ã£o de strings\nsay("Bem-vindo ao " + nome + " " + versao);\n\n// OperaÃ§Ãµes matemÃ¡ticas\nkeep x = 10;\nkeep y = 5;\nkeep soma = x + y;\n\nsay(x + " + " + y + " = " + soma);',
        conditionals: '// Estruturas condicionais\nkeep idade = 20;\n\nwhen (idade >= 18) {\n  say("VocÃª Ã© maior de idade!");\n} else {\n  say("VocÃª Ã© menor de idade!");\n}\n\n// Operadores lÃ³gicos\nkeep tem_carteira = 1;\n\nwhen (idade >= 18 && tem_carteira) {\n  say("Pode dirigir!");\n} else {\n  say("NÃ£o pode dirigir!");\n}',
        loops: '// Loops\nkeep i = 0;\n\n// Loop while\nwhile (i < 5) {\n  say("Contagem: " + i);\n  i = i + 1;\n}\n\n// Loop for\nfor (keep j = 0; j < 3; j = j + 1) {\n  say("IteraÃ§Ã£o: " + j);\n}',
        functions: '// FunÃ§Ãµes\ndo saudacao(nome) {\n  say("OlÃ¡, " + nome + "!");\n  return "SaudaÃ§Ã£o enviada para " + nome;\n}\n\n// Chamando a funÃ§Ã£o\nkeep mensagem = saudacao("Visitante");\nsay("Retorno: " + mensagem);'
      };

      // Elementos da interface
      const editor = document.getElementById('editor');
      const output = document.getElementById('output');
      const runBtn = document.getElementById('run-btn');
      const clearBtn = document.getElementById('clear-btn');
      const exampleSelect = document.getElementById('example-select');
      const statusElement = document.querySelector('.playground-status');

      // Estado do interpretador
      let isReady = false;

      // Inicializar o interpretador Jech
      async function initJech() {
        try {
          updateStatus('â³ Inicializando o interpretador Jech...');
          
          // Inicializar o mÃ³dulo WASM
          await JechWASM.init();
          
          // Verificar se o mÃ³dulo foi inicializado corretamente
          if (!JechWASM.isInitialized()) {
            throw new Error('Falha ao inicializar o interpretador Jech');
          }
          
          // Obter a versÃ£o do interpretador
          const version = await JechWASM.getVersion();
          console.log(`Jech ${version} inicializado com sucesso!`);
          
          // Atualizar estado
          isReady = true;
          runBtn.disabled = false;
          updateStatus('âœ… Interpretador Jech pronto!', 'ready');
          
          // Carregar exemplo inicial
          loadExample('hello');
          
        } catch (error) {
          console.error('Erro ao inicializar o interpretador Jech:', error);
          updateStatus(`âŒ Falha ao inicializar: ${error.message}`, 'error');
          appendOutput(`Erro crÃ­tico: ${error.message}`, true);
        }
      }

      // Carregar exemplo
      function loadExample(name) {
        if (examples[name]) {
          editor.value = examples[name];
          
          // Rolar para o topo do editor
          editor.scrollTop = 0;
          
          // Atualizar o seletor
          exampleSelect.value = name;
          
          // Mostrar mensagem de exemplo carregado
          updateStatus(`âœ… Exemplo "${name.replace(/([A-Z])/g, ' $1').trim()}" carregado`);
          
          // Focar no editor
          editor.focus();
          
          // Ajustar altura do editor
          updateEditorHeight();
        } else {
          updateStatus('âŒ Exemplo nÃ£o encontrado', 'error');
        }
      }

      // Atualizar status
      function updateStatus(message, type = '') {
        statusElement.textContent = message;
        statusElement.className = 'playground-status' + (type ? ` ${type}` : '');
      }

      // Executar cÃ³digo
      async function runCode() {
        if (!isReady) {
          updateStatus('âŒ O interpretador ainda nÃ£o estÃ¡ pronto. Por favor, aguarde...', 'error');
          return;
        }
        
        const code = editor.value.trim();
        if (!code) {
          updateStatus('âŒ Nenhum cÃ³digo para executar', 'error');
          return;
        }
        
        // Limpar saÃ­da anterior
        clearOutput();
        
        // Mostrar o cÃ³digo que estÃ¡ sendo executado
        const codePreview = document.createElement('div');
        codePreview.className = 'code-preview';
        codePreview.innerHTML = `
          <div class="code-preview-header">ğŸš€ Executando cÃ³digo...</div>
          <div class="code-separator">-------------------</div>
          <pre>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
          <div class="code-separator">-------------------</div>
        `;
        output.appendChild(codePreview);
        
        // Executar o cÃ³digo
        const startTime = performance.now();
        updateStatus('âš¡ Executando...', 'running');
        
        try {
          // Executar o cÃ³digo usando o JechWASM
          const result = await JechWASM.execute(code);
          const executionTime = ((performance.now() - startTime) / 1000).toFixed(2);
          
          if (result) {
            updateStatus(`âœ… Executado com sucesso (${executionTime}s)`, 'success');
          } else {
            updateStatus(`âŒ Erro durante a execuÃ§Ã£o (${executionTime}s)`, 'error');
          }
        } catch (error) {
          console.error('Erro ao executar cÃ³digo:', error);
          const errorMessage = error.message || 'Erro desconhecido';
          appendOutput(`âŒ Erro: ${errorMessage}`, true);
          updateStatus('âŒ Erro durante a execuÃ§Ã£o', 'error');
        }
      }

      // Limpar saÃ­da
      function clearOutput() {
        output.textContent = '';
        output.className = '';
        output.classList.add('empty');
      }

      // Adicionar texto Ã  saÃ­da
      function appendOutput(text, isError = false) {
        // Se a saÃ­da estiver vazia, remover a classe 'empty'
        if (output.classList.contains('empty')) {
          output.textContent = '';
          output.className = '';
        }
        
        // Criar elemento de linha de saÃ­da
        const line = document.createElement('div');
        line.className = isError ? 'output-line error' : 'output-line';
        
        // Processar quebras de linha e adicionar cada linha
        const lines = text.split('\n');
        lines.forEach((lineText, index) => {
          if (index > 0) {
            output.appendChild(document.createElement('br'));
          }
          if (lineText) {
            const textNode = document.createTextNode(lineText);
            output.appendChild(textNode);
          }
        });
        
        // Rolar para a Ãºltima linha
        output.scrollTop = output.scrollHeight;
      }

      // Event listeners
      runBtn.addEventListener('click', runCode);
      clearBtn.addEventListener('click', clearOutput);
      
      // Carregar exemplo selecionado
      exampleSelect.addEventListener('change', (e) => {
        if (e.target.value) {
          loadExample(e.target.value);
        }
      });
      
      // Atalhos de teclado
      document.addEventListener('keydown', (e) => {
        // Ctrl+Enter ou Cmd+Enter para executar
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          runCode();
        }
      });
      
      // Configurar altura do editor
      function updateEditorHeight() {
        editor.style.height = 'auto';
        editor.style.height = (editor.scrollHeight) + 'px';
      }
      
      // Inicializar o editor
      function initEditor() {
        // Configurar eventos do editor
        editor.addEventListener('input', updateEditorHeight);
        window.addEventListener('resize', updateEditorHeight);
        updateEditorHeight();
        
        // Inicializar o interpretador Jech
        initJech();
      }
      
      // Inicializar quando o DOM estiver pronto
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEditor);
      } else {
        initEditor();
      }
    </script>
  </body>
</html>
